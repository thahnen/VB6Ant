<?xml version="1.0" encoding="UTF-8" ?>
<project name="VB6Ant" default="vb6.help" xmlns:if="ant:if" xmlns:unless="ant:unless">
    <description>
        Visual Basic 6 (Classic) for Ant

        TODO: Does not support /D or /cmd switches for compiling / running project!
        TODO: Read version information from project file!
    </description>

    <!-- directory of this Ant script -->
    <dirname property="scripts.dir" file="${ant.file}" />

    <!-- environment variables to search for VB6.exe -->
    <property environment="env" />



    <!-- ===========================================================================================================
                                                    MACRO DEFINITIONS
         =========================================================================================================== -->



    <!--
        Check if a property is available and not empty

        IN:     name        -> the property name
    -->
    <macrodef name="checkPropertyAvailable" description="Check if property is available and not empty">
        <attribute name="name" />

        <sequential>
            <fail message="[${ant.project.name}] The property '@{name}' does not exist or is empty!">
                <condition>
                    <or>
                        <not>
                            <isset property="@{name}" />
                        </not>
                        <equals arg1="" arg2="@{name}" />
                    </or>
                </condition>
            </fail>
        </sequential>
    </macrodef>


    <!--
        Script macro to replace specific templates in a file with values provided

        IN:     file        -> the file to replace the templates in
                projectname -> will replace "##TPL_PROJECT_NAME##"
    -->
    <scriptdef name="replaceTemplatesInFile" language="javascript" description="Script macro to replace templates">
        <attribute name="file" />
        <attribute name="projectname" />

        <![CDATA[
            var path = java.io.File(attributes.get("file")).toPath()
            var content = java.nio.file.Files.readAllLines(path, java.nio.charset.Charset.forName("UTF-8));

            // replace necessary templates: ##TPL_PROJECT_NAME## -> @{projectName}
            content = content.replace("##TPL_PROJECT_NAME##", attributes.get("projectname));

            java.nio.file.Files.writeString(path, content, java.nio.file.StandardOpenOption.WRITE);
        ]]>
    </scriptdef>


    <!--
        General macro to call VB6.EXE with arguments

        IN:     args        -> command line arguments for the VB6.EXE
    -->
    <macrodef name="vb6" description="General macro to call VB6.EXE">
        <attribute name="args" default="" />

        <sequential>
            <exec executable="cmd" failonerror="true">
                <env key="PATH" value="${env.PATH}${VB6.path}" />
                <arg line="/C VB6.EXE @{args}" />
            </exec>
        </sequential>
    </macrodef>


    <!--
        Macro to compile a specific project

        IN:     project     -> the full path to the project (excluding file suffix)
                errorfile   -> the file to write the error message to if any appear
                builddir    -> the output directory for the project
    -->
    <macrodef name="vb6.make" description="Macro to call VB6.EXE to compile a specific project">
        <attribute name="project" />
        <attribute name="errorfile" />
        <attribute name="builddir" />

        <sequential>
            <vb6 args="/make @{project}.vbp /out @{errorfile} /outdir @{builddir}" />
        </sequential>
    </macrodef>


    <!--
        Macro to compile and run a specific project

        IN:     project     -> the full path to the project (excluding file suffix)
                errorfile   -> the file to write the error message to if any appear
                builddir    -> the output directory for the project
    -->
    <macrodef name="vb6.run" description="Macro to call VB6.EXE to run a specific project">
        <attribute name="project" />
        <attribute name="errorfile" />
        <attribute name="builddir" />

        <sequential>
            <vb6 args="/runexit @{project}.vbp /out @{errorfile} /outdir @{builddir}" />
        </sequential>
    </macrodef>



    <!-- ===========================================================================================================
                                                        MAIN TARGETS
         =========================================================================================================== -->



    <target name="vb6.init" description="Init Ant targets and check environment: OS / VB6.EXE">
        <!-- i) fail if not Windows -->
        <fail message="[${ant.project.name}] Only available for Windows NT operating systems!">
            <condition>
                <not>
                    <os family="winnt" />
                </not>
            </condition>
        </fail>

        <!-- ii) check if VB6.EXE in ${env.PATH} & search for VB6.EXE (32 / 64-bit OS) -->
        <condition property="VB6.missing">
            <not>
                <contains string="${env.PATH}" substring="VB6.EXE" />
            </not>
        </condition>

        <condition property="VB6.path" value=":C\Program&#160;Files\Microsoft&#160;Visual&#160;Studio\VB98">
            <and>
                <isset property="VB6.missing" />
                <available file="/Program&#160;Files/Microsoft&#160;Visual&#160;Studio/VB98/VB6.EXE" type="file" />
            </and>
        </condition>

        <condition property="VB6.path" value=":C:\Program&#160;Files&#160;(x86)\Microsoft&#160;Visual&#160;Studio\VB98">
            <and>
                <isset property="VB6.missing" />
                <available file="/Program&#160;Files&#160;(x86)/Microsoft&#160;Visual&#160;Studio/VB98/VB6.EXE"
                           type="file" />
            </and>
        </condition>

        <!-- iii) fail if nothing found regarding VB6.EXE -->
        <fail message="[${ant.project.name}] VB6.EXE could neither be found in '${env.PATH}' or default directories!">
            <condition>
                <isset property="VB6.missing" />
                <not>
                    <isset property="VB6.path" />
                </not>
            </condition>
        </fail>

        <condition property="VB6.path" value="">
            <not>
                <isset property="VB6.path" />
            </not>
        </condition>
    </target>


    <target name="vb6.make" depends="vb6.init" description="Target to make the VB6 project">
        <checkPropertyAvailable name="project" />
        <checkPropertyAvailable name="error.file" />
        <checkPropertyAvailable name="build.dir" />

        <vb6.make project="${project}" errorfile="${error.file}" builddir="${build.dir}" />
    </target>


    <target name="vb6.run" depends="vb6.init" description="Target to run the VB6 project">
        <checkPropertyAvailable name="project" />
        <checkPropertyAvailable name="error.file" />
        <checkPropertyAvailable name="build.dir" />

        <vb6.run project="${project}" errorfile="${error.file}" builddir="${build.dir}" />
    </target>


    <target name="vb6.help" depends="vb6.init" description="Opens the helper window for Visual Basic 6!">
        <vb6 args="/?" />
    </target>



    <!-- ===========================================================================================================
                                                    VB6 PROJECT TARGETS
         =========================================================================================================== -->



    <target name="vb6.project.create" description="Target to create a VB6 project directory">
        <checkPropertyAvailable name="baseDir" />
        <checkPropertyAvailable name="projectName" />

        <!-- create project directory (build / scripts / src / test) -->
        <mkdir dir="${baseDir}/${projectName}" />
        <mkdir dir="${baseDir}/${projectName}/build" />
        <mkdir dir="${baseDir}/${projectName}/scripts" />
        <mkdir dir="${baseDir}/${projectName}/src" />
        <mkdir dir="${baseDir}/${projectName}/src/Classes" />
        <mkdir dir="${baseDir}/${projectName}/src/Controls" />
        <mkdir dir="${baseDir}/${projectName}/src/Forms" />
        <mkdir dir="${baseDir}/${projectName}/src/Modules" />
        <mkdir dir="${baseDir}/${projectName}/src/Resources" />

        <!-- create .gitattributes file (special file for handling Windows file endings) -->
        <loadfile property="gitattributes.file" srcfile="${scripts.dir}/templates/template.gitattributes" />
        <echo file="${baseDir}/${projectName}/.gitattributes" append="false" message="${gitattributes.file}" />

        <!-- create .gitignore file (containing the build file, this repository) -->
        <loadfile property="gitignore.file" srcfile="${scripts.dir}/templates/template.gitignore" />
        <echo file="${baseDir}/${projectName}/.gitignore" append="false" message="${gitignore.file}" />

        <!-- create README.md file (containing basic information about the project) -->
        <loadfile property="README.md.file" srcfile="${scripts.dir}/templates/template.README.md" />
        <echo file="${baseDir}/${projectName}/README.md" append="false" message="${README.md.file}" />

        <!-- copy (templated) build.xml files and replace templates -->
        <copy file="${scripts.dir}/templates/template.build.xml" overwrite="false"
              tofile="${baseDir}/${projectName}/scripts/build.xml" />
        <replaceTemplatesInFile file="${baseDir}/${projectName}/scripts/build.xml" projectname="${projectName}" />

        <!-- clone this repository into scripts as a Git submodule -->
        <exec executable="cmd" dir="${baseDir}/${projectName}" failonerror="true">
            <arg line="/C git submodule add https://github.com/thahnen/VB6Ant.git scripts/VB6Ant" />
        </exec>
    </target>


    <target name="vb6.project.check" description="Target to check a VB6 project directory">
        <checkPropertyAvailable name="projectDir" />

        <!-- kommt noch ... -->
    </target>
</project>
